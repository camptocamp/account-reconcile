<?xml version="1.0"?>
<openerp>
    <data>

        <record id="view_crm_case_claims_filter" model="ir.ui.view">
            <field name="name">crm.claim.filter</field>
            <field name="model">crm.claim</field>
            <field name="inherit_id" ref="crm_claim.view_crm_case_claims_filter"/>
            <field name="arch" type="xml">
                <field name="name" position="before">
                    <field name="description"/>
                </field>
                <field name="user_id" position="after">
                  <field name="product_id"/>
                </field>
            </field>
        </record>

        <record id="crm_case_claims_tree_view" model="ir.ui.view">
            <field name="name">CRM - Claims Tree</field>
            <field name="model">crm.claim</field>
            <field name="inherit_id" ref="crm_claim.crm_case_claims_tree_view"/>
            <field name="arch" type="xml">
                <field name="action_next" position="after">
                    <field name="write_date"/>
                </field>
                <field name="action_next" position="attributes">
                    <attribute name="invisible">1</attribute>
                </field>
                <field name="partner_id" position="after">
                    <field name="partner_street"/>
                    <field name="partner_zip"/>
                    <field name="partner_city"/>
                </field>
            </field>
        </record>

        <act_window
                id="act_crm_claim_rma_claim"
                name="Claims"
                res_model="crm.claim"
                src_model="crm.claim"/>

        <act_window
              id="act_crm_claim_rma_picking_out"
              name="Outgoing Shipment"
              res_model="stock.picking"
              src_model="crm.claim"
              context="{'active_test': False}"/>

        <act_window
            id="act_crm_claim_rma_sale_orders_inactive"
            context="{'active_test': False}"
            name="Quotations and Sales"
            res_model="sale.order"
            src_model="crm.claim"/>


        <record id="crm_claim_rma_form_view" model="ir.ui.view">
            <field name="name">crm.claim.rma.form</field>
            <field name="model">crm.claim</field>
            <field name="inherit_id" ref="crm_claim_rma.crm_claim_rma_form_view"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='team_id']" position="before">
                    <field name="qoqa_team_id"/>
                </xpath>
                <!-- add sales count -->
                <button icon="fa-strikethrough" position="replace">
                    <button class="oe_stat_button"
                            name="%(act_crm_claim_rma_sale_orders_inactive)d"
                            type="action"
                            icon="fa-strikethrough"
                            string=""
                            help="The counter shows SO from all companies but the action only open SO from current users companies"
                            attrs="{'invisible': ['|',('partner_id','=', False)]}"
                            context="{'search_default_partner_id': [partner_id], 'search_default_user_id':False, 'active_test': False}">
                  <field string="Sales (inactive included)"
                         name="sale_order_count"
                         context="{'active_test': False}"
                         widget="statinfo"/>
                    </button>
                </button>
                <!-- replace Purchase smart button by Claim smart button -->
                <button icon="fa-shopping-cart" position="replace">
                    <button class="oe_stat_button"
                            icon="fa-comments"
                            name="%(act_crm_claim_rma_claim)d"
                            type="action"
                            attrs="{'invisible': [('partner_id','=', False)]}"
                            context="{'search_default_partner_id': partner_id}">
                        <field string="Claims" name="claim_count" widget="statinfo"/>
                    </button>
                </button>
                <!-- add picking out smart button after "Returns" -->
                <button icon="fa-reply" position="after">
                    <button class="oe_stat_button"
                            icon="fa-truck"
                            name="%(act_crm_claim_rma_picking_out)d"
                            type="action"
                            string="Deliveries"
                            attrs="{'invisible': [('partner_id','=', False)]}"
                            context="{'search_default_partner_id': partner_id, 'search_default_user_id':False}"/>
                </button>

                <field name="name" position="after">
                  <field name="is_user_current" invisible="True"/>
                </field>

                <field name="user_id" position="replace">
                  <label for="user_id"/>
                  <div>
                    <field name="user_id" class="oe_inline"/>
                    <span attrs="{'invisible': [('is_user_current', '=', True)]}">
                    ‚Üê <button string="I take it!" name="assign_current_user" type="object" class="oe_link"/>
                    </span>
                  </div>
                </field>
                <field name="team_id" position="after">
                    <field name="categ_id"
                           options="{'no_create': True, 'no_open': True}"
                           required="1"/>
                </field>
                <xpath expr="//notebook/page/group/field[@name='categ_id']"
                       position="replace"/>
                <field name="partner_id" position="attributes">
                    <attribute name="domain">[('parent_id', '=', False)]</attribute>
                </field>
                <field name="partner_id" position="after">
                    <field name="partner_category_ids" widget="many2many_tags"/>
                </field>
                <field name="partner_phone" position="attributes">
                    <attribute name="required">0</attribute>
                </field>
                <field name="invoice_id" position="attributes">
                    <attribute name="context">{'active_test': False}</attribute>
                </field>
                <field name="delivery_address_id" position="attributes">
                    <attribute name="attrs">{'invisible': [('pick', '=', True)]}</attribute>
                </field>
                <xpath expr="//field[@name='claim_line_ids']/tree/field[@name='state']" position="attributes">
                  <attribute name="invisible">1</attribute>
                </xpath>
                <xpath expr="//field[@name='claim_line_ids']/tree/field[@name='name']" position="attributes">
                  <attribute name="invisible">1</attribute>
                </xpath>
                <xpath expr="//field[@name='claim_line_ids']/tree/field[@name='claim_origin']" position="attributes">
                  <attribute name="invisible">1</attribute>
                </xpath>
                <xpath expr="//field[@name='claim_line_ids']/tree/field[@name='claim_diagnosis']" position="attributes">
                  <attribute name="invisible">1</attribute>
                </xpath>
                <xpath expr="//field[@name='claim_line_ids']/tree/field[@name='warranty_type']" position="after">
                  <field name="warranty_return_address"/>
                </xpath>
                <xpath expr="//field[@name='claim_line_ids']/tree/field[@name='prodlot_id']" position="replace">
                    <field name="return_instruction"/>
                </xpath>
                <button name="%(account.action_account_invoice_refund)d" position="attributes">
                    <attribute name="context">{'invoice_ids': [invoice_id], 'description': name, 'claim_id': id}</attribute>
                </button>
            </field>
        </record>

        <record id="view_crm_claim_search_qoqa_claim" model="ir.ui.view">
            <field name="name">crm.claim.search.qoqa_claim</field>
            <field name="model">crm.claim</field>
            <field name="inherit_id" ref="crm_claim.view_crm_case_claims_filter"/>
            <field name="sequence">0</field>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='user_id']" position="after">
                    <field name="qoqa_team_id"/>
                </xpath>
                <!-- Big thanks to the author of this code in core as there are no names on filters -->
                <!-- I use sequence 0 to be the first view who inherits the original to -->
                <!-- replace the group and give names to filters -->
                <xpath expr="//group[@expand='0']" position="replace">
                    <group expand="0" string="Group By" name="group_by">
                        <filter name="group_partner_id" string="Partner" domain="[]" help="Partner" context="{'group_by':'partner_id'}"/>
                        <filter name="group_user_id" string="Responsible" domain="[]" help="Responsible User" context="{'group_by':'user_id'}"/>
                        <filter name="group_stage_id" string="Stage" domain="[]" context="{'group_by':'stage_id'}"/>
                        <filter name="group_categ_id" string="Type" domain="[]" context="{'group_by':'categ_id'}"/>
                        <filter name="group_date" string="Claim Month" domain="[]" help="Claim Date by Month" context="{'group_by':'date'}"/>
                        <filter name="group_date_deadline" string="Deadline" domain="[]" context="{'group_by':'date_deadline'}"/>
                        <filter name="group_date_closed" string="Closure" domain="[]" help="Date Closed" context="{'group_by':'date_closed'}" groups="base.group_no_one" invisible="1"/>
                        <!-- This is a custom filter -->
                        <filter string="QoQa Teams" name="qoqa_team_id" domain="[]" context="{'group_by': 'qoqa_team_id'}"/>
                    </group>
                </xpath>
            </field>
        </record>

        <!-- Add entry in the "More" drop down list in tree view -->
        <record id="action_code_assign_current_user" model="ir.actions.server">
          <field name="name">I take it!</field>
          <field name="model_id" ref="crm_claim.model_crm_claim"/>
          <field name="state">code</field>
          <field name="condition">True</field>
          <field name="code">self.write(cr, uid, context.get('active_ids', []), {'user_id': uid})</field>
        </record>

        <record id="assign_current_user_action" model="ir.values">
          <field name="name">Action in more menu to assign current user</field>
          <field name="model">crm.claim</field>
          <field name="key">action</field>
          <field name="key2">client_action_multi</field>
          <field name="value" eval="'ir.actions.server,%d'%action_code_assign_current_user"/>
        </record>

        <record id="crm_claim_action_new" model="ir.actions.act_window">
            <field name="name">New Claim</field>
            <field name="res_model">crm.claim</field>
            <field name="view_type">form</field>
            <field name="view_mode">form</field>
            <field name="context">{
                'default_team_id': active_id,
                }</field>
        </record>

     </data>
</openerp>
